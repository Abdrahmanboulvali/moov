<!DOCTYPE html>
<html>
<head>
    <title>Page - General - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>

</head>
<body>
    <!-- Drawer -->
    <div class="drawer" id="drawer">
        <h2>Menu</h2>
        <ul>
            <li><a href="{{ url_for('statistiques') }}">Statistiques</a></li>
            <li><a href="{{ url_for('analyse_temporelle') }}">Analyse temporelle</a></li>
            <li><a href="{{ url_for('utilisateurs') }}">Utilisateurs</a></li>
            <li><a href="{{ url_for('se_deconnecter') }}" class="btn-logout">Se d√©connecter</a></li>
        </ul>
    </div>

    <!-- Contenu principal -->
    <div class="main-content">
        <header>
            <button class="toggle-btn" onclick="toggleDrawer()">‚ò∞</button>
            <h1>Tableau de Bord - Admin</h1>
        </header>

        <section class="dashboard">
            <p>Derni√®re mise √† jour : {{ created_at }}</p>

            <!-- R√©sum√© -->
            {% set top_etat_sorted = top_etats|dictsort(false, 'value') %}
            {% set top_etat = top_etat_sorted[2] if top_etat_sorted else ['', 0] %}
            {% set second_etat = top_etat_sorted[1] if top_etat_sorted|length > 1 else ['', 0] %}
            {% set third_etat = top_etat_sorted[0] if top_etat_sorted|length > 2 else ['', 0] %}

            {% set top_entite_sorted = top_entites|dictsort(false, 'value') %}
            {% set top_entite = top_entite_sorted[2] if top_entite_sorted else ['', 0] %}
            {% set second_entite = top_entite_sorted[1] if top_entite_sorted|length > 1 else ['', 0] %}
            {% set third_entite = top_entite_sorted[0] if top_entite_sorted|length > 2 else ['', 0] %}

            <p>
                Le nombre total de r√©clamations enregistr√©es est de <strong>{{ total }}</strong>.<br>
                L'√©tat le plus fr√©quent est <strong>{{ top_etat[0] }}</strong> avec <strong>{{ top_etat[1] }}</strong> r√©clamations.
                suivi de <strong>{{ second_etat[0] }}</strong> avec <strong>{{ second_etat[1] }}</strong> r√©clamations.
                puis <strong>{{ third_etat[0] }}</strong> avec <strong>{{ third_etat[1] }}</strong> r√©clamations.<br>
                L'entit√© la plus concern√©e est <strong>{{ top_entite[0] }}</strong> avec <strong>{{ top_entite[1] }}</strong> cas signal√©s.
                suivi de <strong>{{ second_entite[0] }}</strong> avec <strong>{{ second_entite[1] }}</strong> cas signal√©s.
                puis <strong>{{ third_entite[0] }}</strong> avec <strong>{{ third_entite[1] }}</strong> cas signal√©s.
            </p>


            <!-- Statistiques globales -->
            <div class="stats-cards">
                <div class="card">
                    <h3>Total R√©clamations</h3>
                    <p>{{ total }}</p>
                </div>
            </div>

            <!-- Top √âtats -->
            <div class="top-list">
                <h2>Top 3 √âtats</h2>
                <ul>
                    {% for etat, count in top_etats.items() %}
                        <li>{{ etat }} : {{ count }}</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Graphe des √âtats -->
            <div class="chart-container">
                <canvas id="etatChart"></canvas>
            </div>

            <!-- Top Entit√©s -->
            <div class="top-list">
                <h2>Top 3 Entit√©s</h2>
                <ul>
                    {% for entite, count in top_entites.items() %}
                        <li>{{ entite }} : {{ count }}</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Graphe des Entit√©s -->
            <div class="chart-container">
                <canvas id="entiteChart"></canvas>
            </div>

            <!-- Bouton de mise √† jour -->
            <a href="{{ url_for('save_reclamation_summary') }}" class="btn-update">üîÑ Mettre √† jour les statistiques</a>
        </section>
    </div>

    <script>
        function toggleDrawer() {
            document.getElementById('drawer').classList.toggle('open');
        }

        // Top √âtats
        const etatLabels = {{ top_etats.keys() | list | tojson }};
        const etatData = {{ top_etats.values() | list | tojson }};

        const ctxEtat = document.getElementById('etatChart').getContext('2d');
        new Chart(ctxEtat, {
            type: 'bar',
            data: {
                labels: etatLabels,
                datasets: [{
                    label: 'Nombre de R√©clamations',
                    data: etatData,
                    backgroundColor: '#42a5f5'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'R√©partition par √âtat'
                    }
                }
            }
        });

        // Top Entit√©s
        const entiteLabels = {{ top_entites.keys() | list | tojson }};
        const entiteData = {{ top_entites.values() | list | tojson }};

        const ctxEntite = document.getElementById('entiteChart').getContext('2d');
        new Chart(ctxEntite, {
            type: 'bar',
            data: {
                labels: entiteLabels,
                datasets: [{
                    label: 'Nombre de R√©clamations',
                    data: entiteData,
                    backgroundColor: '#66bb6a'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'R√©partition par Entit√©'
                    }
                }
            }
        });
    </script>
</body>
</html>
